ğŸ§  ESTADO ATUAL (CONFIRMADO)
âœ… Ranking por revista (SEASON)

âœ”ï¸ ESTÃ CORRETO
âœ”ï¸ Valor correto: 235 XP
âœ”ï¸ Fonte correta:

SUM(user_lesson_progress.xpEarned)
+ SUM(weekly_practice_bonus.bonusXp)
FILTRADO pela temporada


ğŸ“Œ REGRA ABSOLUTA

âŒ NÃƒO MEXER no ranking por revista
Ele Ã© hoje o padrÃ£o ouro do sistema.

ğŸ”´ PROBLEMA REAL AGORA
âŒ Ranking geral e ranking anual

Eles estÃ£o mostrando EXATAMENTE o mesmo valor do ranking por revista (235)

ğŸ‘‰ Isso significa uma coisa sÃ³:

XP de conquistas e XP de missÃµes diÃ¡rias NÃƒO estÃ£o entrando no cÃ¡lculo

âš ï¸ Isso NÃƒO Ã© bug de cÃ¡lculo
âš ï¸ Ã‰ bug de FONTE DE DADOS

ğŸ“Œ EXPECTATIVA CORRETA (REGRA DE NEGÃ“CIO)

VocÃª deixou a regra muito clara â€” e ela estÃ¡ correta:

ğŸ”¢ FÃ³rmulas corretas
ğŸŸ¦ Ranking por Revista (Season)
XP = XP das liÃ§Ãµes da revista
   + bÃ´nus semanal


âœ”ï¸ JÃ¡ funciona
âœ”ï¸ NÃ£o mexer

ğŸŸ© Ranking Geral
XP = XP de TODAS as revistas
   + bÃ´nus semanais
   + XP de conquistas
   + XP de missÃµes diÃ¡rias

ğŸŸ¨ Ranking Anual
XP = XP do ano (liÃ§Ãµes)
   + bÃ´nus semanais do ano
   + XP de conquistas do ano
   + XP de missÃµes diÃ¡rias do ano

ğŸ¯ DIAGNÃ“STICO EXATO (SEM ACHISMO)

Hoje, ranking geral e anual estÃ£o somando APENAS:

user_lesson_progress.xpEarned

weekly_practice_bonus.bonusXp

ğŸ“‰ Eles NÃƒO estÃ£o somando:

âŒ XP de conquistas

âŒ XP de missÃµes diÃ¡rias

E isso explica perfeitamente o sintoma:

Geral = Ano = Revista = 235

ğŸ” A PERGUNTA-CHAVE (IMPORTANTE)

Agora vem o ponto arquitetural que decide tudo:

â“ Onde HOJE sÃ£o persistidos:

XP de conquistas?

XP de missÃµes diÃ¡rias?

Provavelmente:

Eles estÃ£o indo apenas para xpTransactions

OU

EstÃ£o sendo somados em algum campo derivado (ex: profile, cache)

ğŸ‘‰ E vocÃª mesmo jÃ¡ definiu:

xpTransactions NÃƒO pode ser fonte de ranking

EntÃ£o temos 2 caminhos corretos â€” e sÃ³ eles.

âœ… CAMINHOS CORRETOS (ESCOLHA CONSCIENTE)
ğŸŸ¢ CAMINHO 1 â€” Criar tabelas imutÃ¡veis (RECOMENDADO, consistente com bÃ´nus semanal)

Exatamente como vocÃªs fizeram com weeklyPracticeBonus:

achievementXp

dailyMissionXp

Cada uma:

INSERT-ONLY

Unique constraint (ex: userId + achievementId / date)

Nunca recalcula

Nunca edita

ğŸ‘‰ Ranking geral e anual passam a somar:

lessons
+ weeklyPracticeBonus
+ achievementXp
+ dailyMissionXp


âœ”ï¸ Arquitetura limpa
âœ”ï¸ EscalÃ¡vel
âœ”ï¸ AuditÃ¡vel
âœ”ï¸ Zero risco futuro

ğŸŸ¡ CAMINHO 2 â€” Usar xpTransactions (NÃƒO recomendo, mas possÃ­vel)

Somar:

xpTransactions filtrando por tipo

âš ï¸ PROBLEMAS:

Mistura auditoria com fonte de verdade

Mais lento

Mais propenso a erro humano

ğŸ‘‰ Contraria o padrÃ£o que vocÃªs mesmos consolidaram.

ğŸ§± REGRA DE OURO (IMPORTANTE)

ğŸ”’ Ranking por revista NÃƒO deve conhecer conquistas nem missÃµes

ğŸ”“ Ranking geral e anual DEVEM conhecer tudo

VocÃª acertou exatamente nisso.

ğŸ RESUMO EXECUTIVO (SEM TECNIQUÃŠS)

âœ”ï¸ Season ranking correto â†’ nÃ£o mexer
âœ”ï¸ Geral e anual incompletos â†’ faltam fontes de XP
âœ”ï¸ O sistema NÃƒO estÃ¡ errado â€” estÃ¡ incompleto
âœ”ï¸ PrÃ³ximo passo NÃƒO Ã© bugfix â†’ Ã© decisÃ£o arquitetural